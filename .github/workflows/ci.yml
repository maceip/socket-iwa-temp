name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Build with Vite
        run: npm run build

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 5

  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run npm audit
        continue-on-error: true
        run: npm audit --audit-level=moderate

  bench:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Build with Vite
        run: npm run build

      - name: Report artifact sizes
        run: |
          echo "## Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f dist/iwa-sink.swbn ]; then
            swbn_size=$(du -h dist/iwa-sink.swbn | cut -f1)
            echo "Web Bundle (iwa-sink.swbn): $swbn_size" >> $GITHUB_STEP_SUMMARY
          fi

          wasm_files=$(find dist -name "*.wasm" -type f)
          if [ -n "$wasm_files" ]; then
            echo "WASM files:" >> $GITHUB_STEP_SUMMARY
            du -h $wasm_files | awk '{print "  " $2 ": " $1}' >> $GITHUB_STEP_SUMMARY
          fi

          js_files=$(find dist -name "*.js" -type f)
          if [ -n "$js_files" ]; then
            echo "JavaScript files:" >> $GITHUB_STEP_SUMMARY
            du -h $js_files | awk '{print "  " $2 ": " $1}' >> $GITHUB_STEP_SUMMARY
          fi
